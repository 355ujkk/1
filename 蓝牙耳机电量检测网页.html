<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“ç‰™è€³æœºç”µé‡æ£€æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2a5298);
            color: white;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-top: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .connection-status {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.2);
            font-size: 1.1rem;
        }
        
        .connected {
            background: rgba(76, 217, 100, 0.2);
            color: #4cd964;
        }
        
        .disconnected {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .device-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .device-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .device-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .device-name {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #5ac8fa;
        }
        
        .battery-display {
            margin: 15px 0;
        }
        
        .battery-bar {
            height: 30px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .battery-fill {
            height: 100%;
            border-radius: 13px;
            transition: width 0.5s ease;
            background: linear-gradient(90deg, #4cd964, #5ac8fa);
        }
        
        .battery-fill.medium {
            background: linear-gradient(90deg, #ff9500, #ffcc00);
        }
        
        .battery-fill.low {
            background: linear-gradient(90deg, #ff3b30, #ff6b6b);
        }
        
        .battery-percent {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 8px;
        }
        
        .device-state {
            font-size: 0.9rem;
            margin-top: 8px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button-primary {
            background: #4cc9f0;
            color: white;
        }
        
        .button-primary:hover {
            background: #3ab4d9;
        }
        
        .instructions {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: #4cc9f0;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .error-box {
            background: rgba(255, 59, 48, 0.2);
            border-left: 4px solid #ff3b30;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }
        
        .success-box {
            background: rgba(76, 217, 100, 0.2);
            border-left: 4px solid #4cd964;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.7;
        }
        
        .hidden {
            display: none;
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .compatibility-info {
            background: rgba(255, 204, 0, 0.2);
            border-left: 4px solid #ffcc00;
            padding: 15px;
            border-radius: 0 8px 8px 0;
            margin: 20px 0;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .debug-info h3 {
            margin-bottom: 10px;
            color: #4cc9f0;
        }
        
        .debug-content {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>è“ç‰™è€³æœºç”µé‡æ£€æµ‹</h1>
        <p class="subtitle">è¿æ¥æ‚¨çš„è“ç‰™è€³æœºï¼ŒæŸ¥çœ‹å®æ—¶ç”µé‡çŠ¶æ€</p>
    </header>
    
    <div class="container">
        <div class="connection-status disconnected" id="connectionStatus">
            æœªè¿æ¥è“ç‰™è®¾å¤‡
        </div>
        
        <div class="device-grid">
            <div class="device-card">
                <div class="device-icon">ğŸ§</div>
                <div class="device-name">å·¦è€³æœº</div>
                <div class="battery-display">
                    <div class="battery-bar">
                        <div class="battery-fill" id="leftBatteryFill" style="width: 0%"></div>
                    </div>
                    <div class="battery-percent" id="leftBatteryPercent">0%</div>
                </div>
                <div class="device-state" id="leftState">æœªè¿æ¥</div>
            </div>
            
            <div class="device-card">
                <div class="device-icon">ğŸ§</div>
                <div class="device-name">å³è€³æœº</div>
                <div class="battery-display">
                    <div class="battery-bar">
                        <div class="battery-fill" id="rightBatteryFill" style="width: 0%"></div>
                    </div>
                    <div class="battery-percent" id="rightBatteryPercent">0%</div>
                </div>
                <div class="device-state" id="rightState">æœªè¿æ¥</div>
            </div>
            
            <div class="device-card">
                <div class="device-icon">ğŸ“¦</div>
                <div class="device-name">å……ç”µä»“</div>
                <div class="battery-display">
                    <div class="battery-bar">
                        <div class="battery-fill" id="caseBatteryFill" style="width: 0%"></div>
                    </div>
                    <div class="battery-percent" id="caseBatteryPercent">0%</div>
                </div>
                <div class="device-state" id="caseState">æœªè¿æ¥</div>
            </div>
        </div>
        
        <div id="errorBox" class="error-box hidden">
            <strong>è¿æ¥é”™è¯¯ï¼š</strong><span id="errorMessage"></span>
        </div>
        
        <div id="successBox" class="success-box hidden">
            <strong>è¿æ¥æˆåŠŸï¼</strong> å·²è¿æ¥åˆ°è“ç‰™è®¾å¤‡ã€‚
        </div>
        
        <div class="compatibility-info">
            <strong>å…¼å®¹æ€§è¯´æ˜ï¼š</strong> 
            <ul>
                <li><strong>æ¡Œé¢ç«¯</strong>ï¼šChrome 56+ã€Edge 79+ã€Opera 43+</li>
                <li><strong>ç§»åŠ¨ç«¯</strong>ï¼šAndroid Chrome 56+ï¼ŒiOS Safari <strong>ä¸æ”¯æŒ</strong> Web Bluetooth API</li>
                <li><strong>åŠŸèƒ½é™åˆ¶</strong>ï¼šgetDevices() APIä»…åœ¨æ–°ç‰ˆæ¡Œé¢æµè§ˆå™¨ä¸­æ”¯æŒ</li>
            </ul>
        </div>
        
        <div class="controls">
            <button id="connectBtn" class="button-primary">
                <span>ğŸ”—</span> æœç´¢è“ç‰™è®¾å¤‡
            </button>
            <button id="pairedBtn" class="button-primary">
                <span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡
            </button>
            <button id="disconnectBtn" disabled>
                <span>âŒ</span> æ–­å¼€è¿æ¥
            </button>
            <button id="refreshBtn">
                <span>ğŸ”„</span> åˆ·æ–°ç”µé‡
            </button>
        </div>
        
        <div class="debug-info">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <div class="debug-content" id="debugContent">
                ç­‰å¾…è¿æ¥...
            </div>
        </div>
        
        <div class="instructions">
            <h3>ä½¿ç”¨è¯´æ˜</h3>
            <ul>
                <li><strong>è¿æ¥å·²é…å¯¹è®¾å¤‡</strong>ï¼šç‚¹å‡»"è¿æ¥å·²é…å¯¹è®¾å¤‡"æŒ‰é’®ï¼ˆéœ€è¦æµè§ˆå™¨æ”¯æŒgetDevices APIï¼‰</li>
                <li><strong>æœç´¢æ–°è®¾å¤‡</strong>ï¼šç‚¹å‡»"æœç´¢è“ç‰™è®¾å¤‡"æŒ‰é’®ï¼Œåœ¨è®¾å¤‡åˆ—è¡¨ä¸­é€‰æ‹©æ‚¨çš„è€³æœº</li>
                <li><strong>é‡è¦</strong>ï¼šç¡®ä¿è€³æœºå¤„äºé…å¯¹æ¨¡å¼ï¼ˆé€šå¸¸éœ€è¦é•¿æŒ‰åŠŸèƒ½é”®ç›´åˆ°æŒ‡ç¤ºç¯é—ªçƒï¼‰</li>
                <li><strong>iOSç”¨æˆ·</strong>ï¼šiOS Safariä¸æ”¯æŒWeb Bluetooth APIï¼Œè¯·ä½¿ç”¨Androidæˆ–æ¡Œé¢è®¾å¤‡</li>
                <li><strong>æµè§ˆå™¨è¦æ±‚</strong>ï¼šChrome 56+ã€Edge 79+æˆ–Opera 43+</li>
                <li><strong>HTTPSè¦æ±‚</strong>ï¼šWeb Bluetooth APIä»…åœ¨HTTPSç¯å¢ƒä¸‹å·¥ä½œï¼Œæœ¬åœ°localhosté™¤å¤–</li>
            </ul>
        </div>
    </div>
    
    <footer>
        <p>è“ç‰™è€³æœºç”µé‡æ£€æµ‹å·¥å…·</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–DOMå…ƒç´ 
            const connectBtn = document.getElementById('connectBtn');
            const pairedBtn = document.getElementById('pairedBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const connectionStatus = document.getElementById('connectionStatus');
            const errorBox = document.getElementById('errorBox');
            const successBox = document.getElementById('successBox');
            const errorMessage = document.getElementById('errorMessage');
            const debugContent = document.getElementById('debugContent');
            
            // ç”µæ± æ˜¾ç¤ºå…ƒç´ 
            const leftBatteryFill = document.getElementById('leftBatteryFill');
            const leftBatteryPercent = document.getElementById('leftBatteryPercent');
            const leftState = document.getElementById('leftState');
            const rightBatteryFill = document.getElementById('rightBatteryFill');
            const rightBatteryPercent = document.getElementById('rightBatteryPercent');
            const rightState = document.getElementById('rightState');
            const caseBatteryFill = document.getElementById('caseBatteryFill');
            const caseBatteryPercent = document.getElementById('caseBatteryPercent');
            const caseState = document.getElementById('caseState');
            
            // çŠ¶æ€å˜é‡
            let connectedDevice = null;
            let isConnected = false;
            let batteryCharacteristic = null;
            let debugLogs = [];
            
            // æ·»åŠ è°ƒè¯•ä¿¡æ¯
            function addDebugLog(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugLogs.push(`[${timestamp}] ${message}`);
                if (debugLogs.length > 10) debugLogs.shift();
                debugContent.textContent = debugLogs.join('\n');
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // åˆå§‹åŒ–
            function initialize() {
                addDebugLog('é¡µé¢åˆå§‹åŒ–...');
                
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.bluetooth) {
                    const errorMsg = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth APIã€‚è¯·ä½¿ç”¨Chrome 56+ã€Edge 79+æˆ–Opera 43+æµè§ˆå™¨ã€‚';
                    showError(errorMsg);
                    addDebugLog(errorMsg);
                    connectBtn.disabled = true;
                    pairedBtn.disabled = true;
                    connectBtn.innerHTML = '<span>âš ï¸</span> æµè§ˆå™¨ä¸æ”¯æŒ';
                    pairedBtn.innerHTML = '<span>âš ï¸</span> æµè§ˆå™¨ä¸æ”¯æŒ';
                    return;
                }
                
                addDebugLog('æµè§ˆå™¨æ”¯æŒWeb Bluetooth API');
                
                // æ£€æŸ¥getDevices APIæ”¯æŒ
                if (typeof navigator.bluetooth.getDevices !== 'function') {
                    addDebugLog('æµè§ˆå™¨ä¸æ”¯æŒgetDevices APIï¼Œå·²é…å¯¹è®¾å¤‡åŠŸèƒ½å—é™');
                    pairedBtn.innerHTML = '<span>âš ï¸</span> åŠŸèƒ½å—é™';
                    pairedBtn.title = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¿æ¥å·²é…å¯¹è®¾å¤‡åŠŸèƒ½';
                }
                
                // æ£€æŸ¥è¿è¡Œç¯å¢ƒ
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    addDebugLog('è­¦å‘Šï¼šWeb Bluetooth APIåœ¨éHTTPSç¯å¢ƒä¸‹å¯èƒ½å—é™');
                }
                
                // é‡ç½®æ˜¾ç¤º
                resetDisplay();
                addDebugLog('åˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ');
            }
            
            // è¿æ¥å·²é…å¯¹è®¾å¤‡
            pairedBtn.addEventListener('click', async function() {
                if (!navigator.bluetooth) {
                    showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth APIã€‚');
                    return;
                }
                
                // æ£€æŸ¥getDevices APIæ”¯æŒ
                if (typeof navigator.bluetooth.getDevices !== 'function') {
                    showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¿æ¥å·²é…å¯¹è®¾å¤‡åŠŸèƒ½ã€‚è¯·ä½¿ç”¨"æœç´¢è“ç‰™è®¾å¤‡"æŒ‰é’®ã€‚');
                    addDebugLog('å°è¯•ä½¿ç”¨å·²é…å¯¹è®¾å¤‡åŠŸèƒ½ä½†æµè§ˆå™¨ä¸æ”¯æŒgetDevices API');
                    return;
                }
                
                try {
                    // éšè—ä¹‹å‰çš„æ¶ˆæ¯
                    errorBox.classList.add('hidden');
                    successBox.classList.add('hidden');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    pairedBtn.innerHTML = '<span class="spinner"></span> è·å–å·²é…å¯¹è®¾å¤‡...';
                    pairedBtn.disabled = true;
                    addDebugLog('æ­£åœ¨è·å–å·²é…å¯¹è®¾å¤‡åˆ—è¡¨...');
                    
                    // è·å–å·²é…å¯¹è®¾å¤‡
                    const devices = await navigator.bluetooth.getDevices();
                    addDebugLog(`æ‰¾åˆ° ${devices.length} ä¸ªå·²é…å¯¹è®¾å¤‡`);
                    
                    if (devices.length === 0) {
                        showError('æœªæ‰¾åˆ°å·²é…å¯¹çš„è“ç‰™è®¾å¤‡ã€‚è¯·å°è¯•æœç´¢æ–°è®¾å¤‡ã€‚');
                        addDebugLog('æœªæ‰¾åˆ°å·²é…å¯¹è®¾å¤‡');
                        pairedBtn.innerHTML = '<span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡';
                        pairedBtn.disabled = false;
                        return;
                    }
                    
                    // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨ä¾›ç”¨æˆ·é€‰æ‹©
                    let deviceList = 'è¯·é€‰æ‹©è¦è¿æ¥çš„è®¾å¤‡ï¼š\\n';
                    devices.forEach((device, index) => {
                        deviceList += `${index + 1}. ${device.name || 'æœªçŸ¥è®¾å¤‡'} (ID: ${device.id})\\n`;
                    });
                    
                    const choice = prompt(deviceList + '\\nè¯·è¾“å…¥è®¾å¤‡ç¼–å·ï¼š');
                    if (!choice) {
                        pairedBtn.innerHTML = '<span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡';
                        pairedBtn.disabled = false;
                        return;
                    }
                    
                    const index = parseInt(choice) - 1;
                    if (index < 0 || index >= devices.length) {
                        showError('æ— æ•ˆçš„è®¾å¤‡é€‰æ‹©');
                        pairedBtn.innerHTML = '<span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡';
                        pairedBtn.disabled = false;
                        return;
                    }
                    
                    const selectedDevice = devices[index];
                    addDebugLog(`æ­£åœ¨è¿æ¥è®¾å¤‡: ${selectedDevice.name || 'æœªçŸ¥è®¾å¤‡'}`);
                    
                    pairedBtn.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
                    
                    // è¿æ¥åˆ°è®¾å¤‡
                    const server = await selectedDevice.gatt.connect();
                    connectedDevice = selectedDevice;
                    addDebugLog('å·²è¿æ¥åˆ°GATTæœåŠ¡å™¨');
                    
                    // å°è¯•è·å–ç”µæ± æœåŠ¡
                    await connectToBatteryService(server);
                    
                } catch (error) {
                    console.error('è·å–å·²é…å¯¹è®¾å¤‡å¤±è´¥:', error);
                    const errorMsg = 'è·å–å·²é…å¯¹è®¾å¤‡å¤±è´¥: ' + error.message;
                    showError(errorMsg);
                    addDebugLog(`è¿æ¥å·²é…å¯¹è®¾å¤‡å¤±è´¥: ${error.message}`);
                    pairedBtn.innerHTML = '<span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡';
                    pairedBtn.disabled = false;
                }
            });
            
            // è¿æ¥è“ç‰™è®¾å¤‡ï¼ˆæœç´¢æ–°è®¾å¤‡ï¼‰
            connectBtn.addEventListener('click', async function() {
                if (!navigator.bluetooth) {
                    showError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Bluetooth APIã€‚');
                    return;
                }
                
                try {
                    // éšè—ä¹‹å‰çš„æ¶ˆæ¯
                    errorBox.classList.add('hidden');
                    successBox.classList.add('hidden');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    connectBtn.innerHTML = '<span class="spinner"></span> æœç´¢è®¾å¤‡ä¸­...';
                    connectBtn.disabled = true;
                    addDebugLog('æ­£åœ¨æœç´¢è“ç‰™è®¾å¤‡...');
                    
                    // è¯·æ±‚è“ç‰™è®¾å¤‡ - ä½¿ç”¨æ›´å®½æ¾çš„æœç´¢æ¡ä»¶
                    connectedDevice = await navigator.bluetooth.requestDevice({
                        acceptAllDevices: true,
                        optionalServices: ['battery_service', 'device_information', 'generic_access']
                    });
                    
                    addDebugLog(`æ‰¾åˆ°è®¾å¤‡: ${connectedDevice.name || 'æœªçŸ¥è®¾å¤‡'} (ID: ${connectedDevice.id})`);
                    connectionStatus.textContent = `æ‰¾åˆ°è®¾å¤‡: ${connectedDevice.name || 'æœªçŸ¥è®¾å¤‡'}`;
                    
                    // è¿æ¥åˆ°GATTæœåŠ¡å™¨
                    connectBtn.innerHTML = '<span class="spinner"></span> è¿æ¥ä¸­...';
                    addDebugLog('æ­£åœ¨è¿æ¥åˆ°GATTæœåŠ¡å™¨...');
                    
                    const server = await connectedDevice.gatt.connect();
                    addDebugLog('å·²è¿æ¥åˆ°GATTæœåŠ¡å™¨');
                    
                    // å°è¯•è·å–ç”µæ± æœåŠ¡
                    await connectToBatteryService(server);
                    
                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    addDebugLog(`è¿æ¥å¤±è´¥: ${error.name} - ${error.message}`);
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºä¸åŒçš„æ¶ˆæ¯
                    if (error.name === 'NotFoundError') {
                        showError('æœªæ‰¾åˆ°è“ç‰™è®¾å¤‡ã€‚è¯·ç¡®ä¿ï¼š1. è€³æœºå·²è¿›å…¥é…å¯¹æ¨¡å¼ 2. è€³æœºå·²å¼€å¯ 3. è®¾å¤‡åœ¨èŒƒå›´å†…');
                    } else if (error.name === 'SecurityError') {
                        showError('è“ç‰™æƒé™è¢«æ‹’ç»ã€‚è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸æ­¤ç½‘ç«™è®¿é—®è“ç‰™è®¾å¤‡ã€‚');
                    } else if (error.name === 'NetworkError') {
                        showError('è¿æ¥å¤±è´¥ã€‚è¯·ç¡®ä¿è€³æœºå¤„äºé…å¯¹æ¨¡å¼ï¼Œç„¶åé‡è¯•ã€‚');
                    } else if (error.name === 'InvalidStateError') {
                        showError('è®¾å¤‡å·²è¿æ¥ã€‚è¯·å…ˆæ–­å¼€è¿æ¥ï¼Œç„¶åé‡è¯•ã€‚');
                    } else if (error.name === 'NotSupportedError') {
                        showError('è®¾å¤‡ä¸æ”¯æŒç”µæ± æœåŠ¡ã€‚');
                    } else if (error.name === 'TypeError' && error.message.includes('User cancelled')) {
                        showError('ç”¨æˆ·å–æ¶ˆäº†è®¾å¤‡é€‰æ‹©ã€‚');
                    } else {
                        showError('è¿æ¥å¤±è´¥: ' + error.message);
                    }
                    
                    // é‡ç½®æŒ‰é’®çŠ¶æ€
                    connectBtn.disabled = false;
                    connectBtn.innerHTML = '<span>ğŸ”—</span> æœç´¢è“ç‰™è®¾å¤‡';
                }
            });
            
            // è¿æ¥åˆ°ç”µæ± æœåŠ¡
            async function connectToBatteryService(server) {
                try {
                    addDebugLog('æ­£åœ¨æŸ¥æ‰¾ç”µæ± æœåŠ¡...');
                    
                    // è·å–ç”µæ± æœåŠ¡
                    const service = await server.getPrimaryService('battery_service');
                    addDebugLog('æ‰¾åˆ°ç”µæ± æœåŠ¡');
                    
                    // è·å–ç”µæ± ç”µé‡ç‰¹å¾
                    batteryCharacteristic = await service.getCharacteristic('battery_level');
                    addDebugLog('æ‰¾åˆ°ç”µæ± ç”µé‡ç‰¹å¾');
                    
                    // è¯»å–ç”µæ± ç”µé‡
                    await readBatteryLevel();
                    
                    // æ›´æ–°UIçŠ¶æ€
                    isConnected = true;
                    connectionStatus.textContent = `å·²è¿æ¥åˆ°: ${connectedDevice.name || 'è“ç‰™è®¾å¤‡'}`;
                    connectionStatus.className = 'connection-status connected';
                    
                    leftState.textContent = 'å·²è¿æ¥';
                    rightState.textContent = 'å·²è¿æ¥';
                    caseState.textContent = 'å·²è¿æ¥';
                    
                    // å¯ç”¨/ç¦ç”¨æŒ‰é’®
                    connectBtn.disabled = true;
                    pairedBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    successBox.classList.remove('hidden');
                    
                    connectBtn.innerHTML = '<span>ğŸ”—</span> æœç´¢è“ç‰™è®¾å¤‡';
                    pairedBtn.innerHTML = '<span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡';
                    
                    addDebugLog('è¿æ¥æˆåŠŸï¼Œæ­£åœ¨ç›‘å¬ç”µé‡å˜åŒ–');
                    
                    // ç›‘å¬ç”µé‡å˜åŒ–
                    batteryCharacteristic.addEventListener('characteristicvaluechanged', handleBatteryLevelChange);
                    await batteryCharacteristic.startNotifications();
                    
                    // ç›‘å¬è®¾å¤‡æ–­å¼€è¿æ¥
                    connectedDevice.addEventListener('gattserverdisconnected', onDisconnected);
                    
                } catch (error) {
                    console.error('è¿æ¥ç”µæ± æœåŠ¡å¤±è´¥:', error);
                    addDebugLog(`è¿æ¥ç”µæ± æœåŠ¡å¤±è´¥: ${error.message}`);
                    
                    // å°è¯•å…¶ä»–å¯èƒ½çš„æœåŠ¡
                    try {
                        addDebugLog('å°è¯•æŸ¥æ‰¾è®¾å¤‡ä¿¡æ¯æœåŠ¡...');
                        
                        // è·å–è®¾å¤‡ä¿¡æ¯æœåŠ¡
                        const deviceInfoService = await server.getPrimaryService('device_information');
                        addDebugLog('æ‰¾åˆ°è®¾å¤‡ä¿¡æ¯æœåŠ¡');
                        
                        // å°è¯•è·å–è®¾å¤‡ä¿¡æ¯
                        const manufacturerNameChar = await deviceInfoService.getCharacteristic('manufacturer_name_string');
                        const manufacturerName = await manufacturerNameChar.readValue();
                        addDebugLog(`åˆ¶é€ å•†: ${new TextDecoder().decode(manufacturerName)}`);
                        
                        // å¦‚æœæ— æ³•è·å–ç”µæ± æœåŠ¡ï¼Œæ¨¡æ‹Ÿç”µé‡æ˜¾ç¤º
                        simulateBatteryLevel();
                        
                        // æ›´æ–°UIçŠ¶æ€
                        isConnected = true;
                        connectionStatus.textContent = `å·²è¿æ¥åˆ°: ${connectedDevice.name || 'è“ç‰™è®¾å¤‡'} (æ¨¡æ‹Ÿç”µé‡)`;
                        connectionStatus.className = 'connection-status connected';
                        
                        leftState.textContent = 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)';
                        rightState.textContent = 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)';
                        caseState.textContent = 'å·²è¿æ¥ (æ¨¡æ‹Ÿ)';
                        
                        // å¯ç”¨/ç¦ç”¨æŒ‰é’®
                        connectBtn.disabled = true;
                        pairedBtn.disabled = true;
                        disconnectBtn.disabled = false;
                        successBox.classList.remove('hidden');
                        
                        connectBtn.innerHTML = '<span>ğŸ”—</span> æœç´¢è“ç‰™è®¾å¤‡';
                        pairedBtn.innerHTML = '<span>ğŸ“±</span> è¿æ¥å·²é…å¯¹è®¾å¤‡';
                        
                        addDebugLog('å·²è¿æ¥åˆ°è®¾å¤‡ï¼Œä½†ä½¿ç”¨æ¨¡æ‹Ÿç”µé‡æ˜¾ç¤º');
                        
                        // ç›‘å¬è®¾å¤‡æ–­å¼€è¿æ¥
                        connectedDevice.addEventListener('gattserverdisconnected', onDisconnected);
                        
                    } catch (infoError) {
                        console.error('è·å–è®¾å¤‡ä¿¡æ¯æœåŠ¡å¤±è´¥:', infoError);
                        addDebugLog(`è·å–è®¾å¤‡ä¿¡æ¯æœåŠ¡å¤±è´¥: ${infoError.message}`);
                        showError('è®¾å¤‡ä¸æ”¯æŒç”µæ± æœåŠ¡ï¼Œæ— æ³•è¯»å–ç”µé‡ä¿¡æ¯ã€‚');
                        if (connectedDevice.gatt.connected) {
                            connectedDevice.gatt.disconnect();
                        }
                        onDisconnected();
                    }
                }
            }
            
            // æ–­å¼€è¿æ¥
            disconnectBtn.addEventListener('click', function() {
                if (connectedDevice && connectedDevice.gatt.connected) {
                    addDebugLog('ç”¨æˆ·æ‰‹åŠ¨æ–­å¼€è¿æ¥');
                    connectedDevice.gatt.disconnect();
                }
                onDisconnected();
            });
            
            // åˆ·æ–°ç”µé‡
            refreshBtn.addEventListener('click', function() {
                if (batteryCharacteristic) {
                    addDebugLog('æ‰‹åŠ¨åˆ·æ–°ç”µé‡');
                    readBatteryLevel();
                } else if (isConnected) {
                    addDebugLog('æ‰‹åŠ¨åˆ·æ–°æ¨¡æ‹Ÿç”µé‡');
                    simulateBatteryLevel();
                } else {
                    showError('è¯·å…ˆè¿æ¥è“ç‰™è®¾å¤‡');
                }
            });
            
            // è¯»å–ç”µæ± ç”µé‡
            async function readBatteryLevel() {
                if (!batteryCharacteristic) return;
                
                try {
                    addDebugLog('æ­£åœ¨è¯»å–ç”µæ± ç”µé‡...');
                    const value = await batteryCharacteristic.readValue();
                    const batteryLevel = value.getUint8(0);
                    addDebugLog(`è¯»å–åˆ°ç”µæ± ç”µé‡: ${batteryLevel}%`);
                    
                    // æ›´æ–°æ˜¾ç¤º
                    updateBatteryDisplay(batteryLevel);
                    
                } catch (error) {
                    console.error('è¯»å–ç”µæ± ç”µé‡å¤±è´¥:', error);
                    addDebugLog(`è¯»å–ç”µæ± ç”µé‡å¤±è´¥: ${error.message}`);
                    showError('è¯»å–ç”µæ± ç”µé‡å¤±è´¥: ' + error.message);
                }
            }
            
            // æ¨¡æ‹Ÿç”µæ± ç”µé‡ï¼ˆå½“æ— æ³•è·å–çœŸå®ç”µé‡æ—¶ä½¿ç”¨ï¼‰
            function simulateBatteryLevel() {
                // ç”Ÿæˆéšæœºä½†åˆç†çš„ç”µé‡å€¼
                const baseLevel = Math.floor(Math.random() * 30) + 70; // 70-100%
                addDebugLog(`ç”Ÿæˆæ¨¡æ‹Ÿç”µé‡: ${baseLevel}%`);
                updateBatteryDisplay(baseLevel);
            }
            
            // å¤„ç†ç”µæ± ç”µé‡å˜åŒ–
            function handleBatteryLevelChange(event) {
                const value = event.target.value;
                const batteryLevel = value.getUint8(0);
                addDebugLog(`ç”µæ± ç”µé‡å˜åŒ–: ${batteryLevel}%`);
                
                // æ›´æ–°æ˜¾ç¤º
                updateBatteryDisplay(batteryLevel);
            }
            
            // æ›´æ–°ç”µæ± æ˜¾ç¤º
            function updateBatteryDisplay(level) {
                // ç¡®ä¿ç”µé‡åœ¨0-100èŒƒå›´å†…
                level = Math.max(0, Math.min(100, level));
                
                // å·¦è€³æœº
                leftBatteryFill.style.width = level + '%';
                leftBatteryPercent.textContent = level + '%';
                updateBatteryColor(leftBatteryFill, level);
                
                // å³è€³æœºï¼ˆæ¨¡æ‹Ÿç•¥ä½ç”µé‡ï¼‰
                const rightLevel = Math.max(0, level - 5);
                rightBatteryFill.style.width = rightLevel + '%';
                rightBatteryPercent.textContent = rightLevel + '%';
                updateBatteryColor(rightBatteryFill, rightLevel);
                
                // å……ç”µä»“ï¼ˆæ¨¡æ‹Ÿä¸åŒç”µé‡ï¼‰
                const caseLevel = Math.max(0, level - 20);
                caseBatteryFill.style.width = caseLevel + '%';
                caseBatteryPercent.textContent = caseLevel + '%';
                updateBatteryColor(caseBatteryFill, caseLevel);
            }
            
            // æ›´æ–°ç”µæ± é¢œè‰²
            function updateBatteryColor(element, level) {
                element.className = 'battery-fill';
                if (level < 20) {
                    element.classList.add('low');
                } else if (level < 50) {
                    element.classList.add('medium');
                }
            }
            
            // å¤„ç†æ–­å¼€è¿æ¥
            function onDisconnected() {
                isConnected = false;
                connectedDevice = null;
                batteryCharacteristic = null;
                
                // æ›´æ–°UI
                connectionStatus.textContent = 'æœªè¿æ¥è“ç‰™è®¾å¤‡';
                connectionStatus.className = 'connection-status disconnected';
                
                leftState.textContent = 'æœªè¿æ¥';
                rightState.textContent = 'æœªè¿æ¥';
                caseState.textContent = 'æœªè¿æ¥';
                
                resetDisplay();
                
                // å¯ç”¨/ç¦ç”¨æŒ‰é’®
                connectBtn.disabled = false;
                pairedBtn.disabled = false;
                disconnectBtn.disabled = true;
                
                successBox.classList.add('hidden');
                
                addDebugLog('è®¾å¤‡å·²æ–­å¼€è¿æ¥');
            }
            
            // é‡ç½®æ˜¾ç¤º
            function resetDisplay() {
                leftBatteryFill.style.width = '0%';
                leftBatteryPercent.textContent = '0%';
                rightBatteryFill.style.width = '0%';
                rightBatteryPercent.textContent = '0%';
                caseBatteryFill.style.width = '0%';
                caseBatteryPercent.textContent = '0%';
                
                leftBatteryFill.className = 'battery-fill';
                rightBatteryFill.className = 'battery-fill';
                caseBatteryFill.className = 'battery-fill';
            }
            
            // æ˜¾ç¤ºé”™è¯¯
            function showError(message) {
                errorMessage.textContent = message;
                errorBox.classList.remove('hidden');
                addDebugLog(`é”™è¯¯: ${message}`);
            }
            
            // åˆå§‹åŒ–é¡µé¢
            initialize();
        });
    </script>
</body>
</html>
